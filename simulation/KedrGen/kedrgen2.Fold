      SUBROUTINE KEDRGEN2(EACT,VERG)
c********************************************************************
c
c   Primary tracks kinematics: generators 301-400, V.A.Tayursky
c
c   Calls: GUKINE -> KEDRGEN -> KEDRGEN2  
c
c   Output: EACT - actual energy (GeV) of beam in cms. EACT=0 - special
c           /PKIN/ - contains event 
c           VERG(3) - vertex from generators
c
c   Last changes: see A_history
c
c********************************************************************
      IMPLICIT NONE

      Real *4 PI,TWOPI,PIBY2,DEGRAD,RADDEG,CLIGHT,BIG,EMASS
      COMMON/GCONST/PI,TWOPI,PIBY2,DEGRAD,RADDEG,CLIGHT,BIG,EMASS

      INTEGER *4 NTRACK,IPARTICLE
      REAL *4 EPART,PXPART,PYPART,PZPART
      COMMON /PKIN/ NTRACK,IPARTICLE(50),EPART(50),     ! - for output file
     +              PXPART(50),PYPART(50),PZPART(50)

c#include "../KedrSim/pkin.inc"

      Integer *4 IDEBUG,IDEMIN,IDEMAX,ITEST,IDRUN,IDEVT,IEORUN,
     &           IEOTRI,IEVENT,ISWIT,IFINIT,NEVENT,NRNDM
      COMMON/GCFLAG/IDEBUG,IDEMIN,IDEMAX,ITEST,IDRUN,IDEVT,IEORUN
     +        ,IEOTRI,IEVENT,ISWIT(10),IFINIT(20),NEVENT,NRNDM(2)

      Real *4 GENPAR
      Integer *4 KHEP,KGEN
      COMMON /KEDR_GEN/KHEP,KGEN,GENPAR(20) ! input parameters for generators

      Real *8 pPart,mPart
      Integer *4 KfTyp,IParent,IChilds,NPS
      COMMON /PSEVT/ pPart(4,100),mPart(100),KfTyp(100),
     &               IParent(100),IChilds(2,100),NPS

      Real *8 PIPS,AMASS
      Integer *4 NGNT
      COMMON /PSCONS/  PIPS,AMASS(600),NGNT

      Integer *4 NPIND,INDP
      COMMON /PSPIND/  NPIND,INDP(600)

      Real *8 PHSI,ERPHSI,SN,WM,FMAJ
      Integer *4 NGTEE,NEST,NCALLS
      COMMON /PSEEHPS/ PHSI,ERPHSI,SN,WM,FMAJ,NGTEE,NEST,NCALLS

      Real *8 TSEC,ERSEC,WEMAX,GGEST,GWE
      Integer *4 NOBR,NGT,NGT1,KODVDM,IOBR
      COMMON /PSGGHPS/ TSEC,ERSEC,WEMAX,GGEST,GWE,NGT,NGT1,KODVDM,NOBR,
     &                 IOBR

      INTEGER *4 NPART,IPART
      REAL *4 P41
      COMMON /GGHPRT/  NPART,P41(4,20),IPART(20)               ! gen. 306,307

      INTEGER *4 IVEDUM,INPMAJ,IVEDUM1
      REAL *8 FMAXI
      COMMON /VECO /   IVEDUM(2),INPMAJ,IVEDUM1(1635),FMAXI    ! gen. 317         

      INTEGER *4 N,KK
      REAL *4 P,V
      COMMON /LUJETS/  N,KK(4000,5),P(4000,5),V(4000,5)             !: 315

      INTEGER *4 KCHG
      REAL *4 PMAS,PARF,VCKM
      COMMON /LUDAT2/  KCHG(500,3),PMAS(500,4),PARF(2000),VCKM(4,4) !: 315

      INTEGER *4 MDCY,MDME,KFDP
      REAL *4 BRAT
      COMMON /LUDAT3/  MDCY(500,3),MDME(2000,2),BRAT(2000),KFDP(2000,5) !: 315

      REAL *8 SAP,SAPT,CROSEC
      COMMON /GG_EESAP/SAP(4),SAPT,CROSEC ! 307 

      INTEGER NMXHEP
      PARAMETER (NMXHEP=2000)

      COMMON /HEPEVT/             ! for PHOTOS
     $      nevhep,               ! serial number
     $      nhep,                 ! number of particles
     $      isthep(nmxhep),       ! status code
     $      idhep(nmxhep),        ! particle ident KF   
     $      jmohep(2,nmxhep),     ! parent particles
     $      jdahep(2,nmxhep),     ! childreen particles
     $      phep(5,nmxhep),       ! four-momentum, mass [GeV]
     $      vhep(4,nmxhep)        ! vertex [mm]
      REAL*8  phep,  vhep         ! to be real*4 / *8  depending on host
      INTEGER nevhep,nhep,isthep,idhep,jmohep, jdahep

      COMMON /BBYRESLTS/ CTRL,XNCALLS,SEZ,ERR,WSEZ,WERR,SDMAX,SDMAXR, ! 323
     &                   BBYEVENT(25)
      REAL *8 CTRL,XNCALLS,SEZ,ERR,WSEZ,WERR,SDMAX,SDMAXR
      REAL *4 BBYEVENT

      INTEGER *4 ITER,NPRT,KC
c
      REAL *4 VERTEX(3),PLAB(3),ARREVT(7,100),EVENT(6,100)
      REAL *4 ECM,EN1,WEID(4)
      REAL *4 PTLIFE,PCHARGE,PAMASS,PP,UB,TLIFE,CHARGE
      REAL *4 RE_INT,PMASS,VEPART(4,4)
      REAL *4 TI1,TS1,AVGI,SD,CHI2A,EACT,VERG(3)
      REAL *8 ALT,ACC,ANGMIN,EBEAM,FMAX
      REAL *8 QQ(4,10),OMEMIN,HSIGB,VSIGB,ELEFIN(4),PHOFIN(4)
      REAL *8 SECBREM,ERRBREM,GENPAR8(20),THSIGB,TVSIGB
      REAL *8 APMASS,WIDTH,CHRG,SPIN,CTAU,THMIN,THMAX,EMIN,ZMAX
      INTEGER *4 I,KODHEP,IDC,IMODE,I1_CHAN,NB_CHAN,KC_PSI1,KS
      INTEGER *4 NSTABL,ITRTYPE,J,NWB,ITRTYP,ICALLS,MDEC,LUCOMP,NEVREAD
      INTEGER *4 ITYP,ITHEP,ICALLS1,ICALLS2,KODTAG1,IREGGGH,KVDM
      INTEGER *4 KODTAG,ITYPE,KGE,KHE,IGE,INT_RE
      INTEGER *4 KPART(100),ITPS(20),IGENPAR(20),IPROC,ISORT(10),IR
      INTEGER *4 IRES,IMAX,I1
      CHARACTER *20 NAMPART,CHNPAR
      CHARACTER *12 ANAME	
      CHARACTER *15 TEXT320(3)
      CHARACTER *14 T315(12)
      EQUIVALENCE (RE_INT,INT_RE)
c
      SAVE
c
      DATA TEXT320/'e+e-(n gam)    ','mu+mu-(n gam)  ',
     &             'tau+tau-(n gam)'/
c
      DATA T315/'all','e+ e-','mu+ mu-','rndmflav','J/psi pi+ pi-',
     &         'J/psi pi0 pi0','J/psi eta0','J/psi pi0','chi_c0 gamma',
     &          'chi_c1 gamma','chi_c2 gamma','eta_c gamma'/
c
      DO I=1,20
        IGENPAR(I)=IFIX(GENPAR(I))   ! real -> integer 
      END DO
c
      DO I=1,3
        VERG(I)=0.    ! def. vertex from generators
      END DO
c
c-------------------------------------------------------------------
c
c    Determination of process for simulation from IKINE=KGEN (GENE card)
c    ===================================================================
c
c**  KGEN=301-323: V.A.Tayursky
c
      IF(KGEN.EQ.301) GOTO 301 ! e+e- -> hadrons (stat.model)
      IF(KGEN.EQ.302) GOTO 302 ! e+e- -> e+e- + hadrons (stat.model)
      IF(KGEN.EQ.303) GOTO 309 ! e+e- -> e+e- + pi0
      IF(KGEN.EQ.304) GOTO 309 ! e+e- -> e+e- + eta
      IF(KGEN.EQ.305) GOTO 309 ! e+e- -> e+e- + eta'
      IF(KGEN.EQ.306) GOTO 306 ! e+e- -> e+e- + mu(tau)+mu(tau)- (gamma) 
      IF(KGEN.EQ.307) GOTO 307 ! e+e- -> e+e- + e+e-
      IF(KGEN.EQ.308) GOTO 308 ! e+e- -> J/psi(psi') ->VP
      IF(KGEN.EQ.309) GOTO 309 ! e+e- -> e+e- + X, X - any GEANT particle. 
      IF(KGEN.EQ.310) GOTO 310 ! gukine_t reads event from file
      IF(KGEN.EQ.311) GOTO 311 ! e+e- -> psi' -> J/psi(->l+l-) +pi+pi-
      IF(KGEN.EQ.312) GOTO 312 ! 1 particle with test print (from gustep)
      IF(KGEN.EQ.313) GOTO 313 ! e+e- -> tau+ tau- (gamma) (KORALB)
      IF(KGEN.EQ.314) GOTO 314 ! e+e- -> A+Bz+Cz^2, z=cos(teta)
      IF(KGEN.EQ.315) GOTO 315 ! e+e- -> psi' (jetset)
      IF(KGEN.EQ.316) GOTO 316 ! e+e- -> gamma + X (gamma d.f. ~ 1+cos^2 teta)
      IF(KGEN.EQ.317) GOTO 317 ! e+e- -> e+e- + e+e-(mu+mu-) (J.A.M.Vermas.)
      IF(KGEN.EQ.318) GOTO 318 ! e+e- -> e+e- + tau+tau- (J.A.M.Vermaseren)
      IF(KGEN.EQ.319) GOTO 319 ! e+e- -> e+e- + pi+pi- 
      IF(KGEN.EQ.320) GOTO 320 ! KMD-generator
      IF(KGEN.EQ.321) GOTO 321 ! e+e- -> e+ e- gamma (Bremsstrahlung)
      IF(KGEN.EQ.322) GOTO 309 ! e+e- -> e+ e- + eta_c
      IF(KGEN.EQ.323) GOTO 323 ! e+e- -> e+ e-, mu+mu, gam gam, pi+pi- Ó Ò.Ð.
c
      PRINT *,' Wrong generator number! See the KEDR WWW page '
      stop
c
c=======================================================================
c
 301  CONTINUE
c
c  e+e- -> hadrons (stat.model)
c
      DO I=1,20
        ITPS(I)=0
      END DO
c
      IF(IGENPAR(2).LT.1.OR.IGENPAR(2).GT.2) THEN 
        print *,' GUKINE_T, error: regime for generator # 301',
     +      	' should be 1 or 2'                  	  
        STOP                                         	  
      END IF
c
      EACT=GENPAR(1)          ! actual beam energy
      GENPAR8(1)=GENPAR(1)
      GENPAR8(3)=GENPAR(3)    ! paramaters for multiplicity generation
      GENPAR8(4)=GENPAR(4)
c
      IF (IGENPAR(2).EQ.1) GOTO 3    ! generator regime 
c
      DO I=1,17                      ! fixed mult.events, <=16 particles
        IGE=IGENPAR(I+3)             ! Geant-code of final paticle
        IF(IGE.GE.1) ITPS(I)=IGE
      END DO
c
 3    CONTINUE
c                    Ebeam     Ireg      AMC          AMN      NT     
      CALL PstEeH(GENPAR8(1),IGENPAR(2),GENPAR8(3),GENPAR8(4),ITPS,
     &            GENPAR8(3))                                       ! N_pi
c                      Maj for Ireg=2                    
c
      DO 2 I=1,NPS
c
        KHE=KfTyp(I)              ! HEP-code of particle
c
        CALL PstPCode1(KHE,KGE)  ! HEP-code -> GEANT-code
c
        PLAB(1)=pPart(1,I)
        PLAB(2)=pPart(2,I)
        PLAB(3)=pPart(3,I)
        ITYPE=KGE
c
        NTRACK=I
        IPARTICLE(I)=ITYPE
        EPART(I)=pPart(4,I)
        PXPART(I)=PLAB(1)
        PYPART(I)=PLAB(2)
        PZPART(I)=PLAB(3)
c
 2    CONTINUE
c
      IF(IEVENT.EQ.NEVENT) PRINT 401,WM,NGTEE
      GOTO 500
c
c=======================================================================
c
 302  CONTINUE
c
c  e+e- -> e+e- + hadrons (stat.model)
c
      DO I=1,20
        ITPS(I)=0
      END DO
c
      IF(IGENPAR(2).LT.1.OR.IGENPAR(2).GT.2) THEN 
        PRINT *,' GUKINE_T, ERROR: regime for generator # 302',
     +          ' should be 1 or 2'
        STOP
      END IF  
c
      KODTAG=IGENPAR(3)
c
      IF(KODTAG.LT.0.OR.KODTAG.GT.2) THEN
        PRINT *,' GUKINE_T, error: Itag for generator # 302',
     +	        ' should be 0, 1 or 2'   
        STOP
      END IF
c
      EACT=GENPAR(1)         !  actual beam energy
      KVDM=IGENPAR(7)
      GENPAR8(1)=GENPAR(1)
      GENPAR8(4)=GENPAR(4)
      GENPAR8(5)=GENPAR(5)
      GENPAR8(6)=GENPAR(6)
      GENPAR8(8)=GENPAR(8)
      GENPAR8(9)=GENPAR(9)
      GENPAR8(10)=GENPAR(10)
      GENPAR8(11)=GENPAR(11)
      GENPAR8(12)=GENPAR(12)
      GENPAR8(13)=GENPAR(13)
c
      IF(IGENPAR(2).EQ.2) GOTO 6    ! to 2-nd regime
c...........
c  1-st  regime
      IREGGGH=1              ! for variable event composition
c
      GOTO 390
c...........
c  2-nd regime. Fixeed event composition (gg-system of 1 - 8 particles)
c
 6    IREGGGH=2
      GENPAR8(12)=0.D0
      GENPAR8(13)=0.D0
c
      DO I=1,8                      ! fixed mult.events, <=10 particles
        IGE=IGENPAR(I+11)           ! Geant-code of final paticle
        IF(IGE.GE.1) ITPS(I)=IGE
      END DO
c
c                    Eb         Wmin      Wmax      IREG     AMC
 390  CALL PstGgH(GENPAR8(1),GENPAR8(4),GENPAR8(5),IREGGGH, GENPAR8(12),
c         AMN                SEC       KVDM     -t1mi     -t1ma  
     &   GENPAR8(13),ITPS, GENPAR8(6), KVDM, GENPAR8(8),GENPAR8(9),
c         -t2mi     -t2ma       
     &   GENPAR8(10),GENPAR8(11))     
c
      ICALLS=0
      ICALLS1=0
      ICALLS2=0
c
      IF(KODTAG.GT.0) THEN    ! are there hits into tagging system?
c
        CALL TS_TAG(302,GENPAR(1),KODTAG1,ICALLS,ICALLS1,ICALLS2)
c
        IF(KODTAG1.LT.KODTAG) GOTO 390
      END IF
c
      DO 32 I=1,NPS   
c
        KHE=KfTyp(I)              ! HEP-code of particle
c
        CALL PstPCode1(KHE,KGE)  ! HEP-code -> GEANT-code
c
        PLAB(1)=pPart(1,I)
        PLAB(2)=pPart(2,I)
        PLAB(3)=pPart(3,I)
        ITYPE=KGE
c
        NTRACK=I
        IPARTICLE(I)=ITYPE
        EPART(I)=pPart(4,I) 
        PXPART(I)=PLAB(1) 
        PYPART(I)=PLAB(2)
        PZPART(I)=PLAB(3)
c
 32   CONTINUE
c
      IF(IEVENT.EQ.NEVENT.AND.IGENPAR(3).NE.0) PRINT 3022,
     &  (1.*ICALLS1)/ICALLS,(1.*ICALLS2)/ICALLS
c
      IF(IEVENT.EQ.NEVENT) THEN 
        ALT=NEVENT/TSEC
        PRINT 402,TSEC,ERSEC,ALT
      END IF
c
      GOTO 500
c
c=======================================================================
c
 306  continue
c
c     e+e- -> e+e- + mu+mu-(gamma) (F.A.Berends e.a)
c  or  
c     e+e- -> e+e- + tau+tau-(gamma) (F.A.Berends e.a)
c
c
c    Parameters:
c 
c     genpar(1)= Ebeam
c     genpar(2)= KODtag = 0,1,2 - tagging of sc.el.
c     genpar(3)= regime (0-generator, /=0 +cross section estimation)
c     genpar(4)= Kmin(gamma), 
c     genpar(5)= min inv.mass mu+mu- or tau+tau- in GeV,
c     genpar(6)= majoranta
c     genpar(7)= 0/1: two-photon production mu+mu-/ tau+tau-
c
      KODtag=genpar(2)
      EACT=GENPAR(1)     ! actual beam energy
c
 3061 call gen_ggmmg(genpar(1),igenpar(3),genpar(4),genpar(5),genpar(6),
     +               igenpar(7))
c
      if(KODtag.gt.0) then
c
        CALL TS_TAG(306,genpar(1),KODtag1,ICALLS,ICALLS1,ICALLS2)
c
        IF(KODtag1.lt.KODtag) GOTO 3061
      end if
c
      DO I=1,NPART
        PLAB(1)=P41(1,I)
        PLAB(2)=P41(2,I)
        PLAB(3)=P41(3,I)
        ITYPE=IPART(I)
c
        IF(IGENPAR(7).EQ.1) THEN
          IF(I.EQ.3) ITYPE=51         ! tau+  should decay in kedr_dec.dat
          IF(I.EQ.4) ITYPE=52         ! tau-  ............................
        END IF
c
        NTRACK=I
        IPARTICLE(I)=ITYPE
c
        EPART(I)=P41(4,I)
        PXPART(I)=PLAB(1)
        PYPART(I)=PLAB(2)
        PZPART(I)=PLAB(3)
c
      END DO
c
      if(IEVENT.EQ.NEVENT.AND.IGENPAR(2).NE.0) print 3022,
     &  (1.*ICALLS1)/ICALLS,(1.*ICALLS2)/ICALLS
      GOTO 500
c
c=======================================================================
c
 307  continue
c
c  e+e- -> e+e- + e+e- (F.A.Berends e.a., all diagrams)
c
c   Parameters:
c
c   genpar(1)= Ebeam
c   genpar(2)= option of cut: 0 - no cut, 1,2 - tagging
c   genpar(3)= Numb.of events for cr.sec est (if <1000, then changed to 1000)
c   genpar(4)= WEID(1) - weight of multipheriph. subgenerator
c   genpar(5)= WEID(2) - weight of bremsstr. subgenerator
c   genpar(6)= WEID(3) - weight of conversion subgenerator
c   genpar(7)= WEID(4) - weight of annihil. subgenerator
c   genpar(8)= min inv.mass e+e-, 
c   genpar(9)= max inv.mass e+e, 
c   genpar(10)= min angle of secondary particle in Central Detector (deg.)
c   genpar(11)= max angle of secondary particle in CD (deg.)
c   genpar(12)= majoranta (1.0 or less)
c
c   igenpar(3) /=0: cross section calculation before events generation
c
      EACT=GENPAR(1)        ! actual beam energy
      KODtag=igenpar(2)
      KODTAG1=IGENPAR(3)
      IF(KODTAG1.LT.1000) KODTAG1=1000 ! cr.section is estimated by min 1000 ev
      WEID(1)=IGENPAR(4)
      WEID(2)=IGENPAR(5)
      WEID(3)=IGENPAR(6)
      WEID(4)=IGENPAR(7)
c
 3071 call GEN_GGEE(genpar(1),KODTAG1,WEID,genpar(8),genpar(9),
     &              genpar(10),genpar(11),genpar(12))
c
      IF(KODTAG.GT.0) THEN  
c
        CALL TS_TAG(307,genpar(1),KODTAG1,ICALLS,ICALLS1,ICALLS2)
c
        IF(KODtag1.lt.KODtag) GOTO 3071
      END IF
c
      DO I=1,NPART
        PLAB(1)=P41(1,i)
        PLAB(2)=P41(2,i)
        PLAB(3)=P41(3,i)
        ITYPE=IPART(i)
c
        NTRACK=I
        IPARTICLE(I)=ITYPE
        EPART(I)=P41(4,I)
        PXPART(I)=PLAB(1)
        PYPART(I)=PLAB(2)
        PZPART(I)=PLAB(3)
c
      end do
c
      IF(IEVENT.EQ.NEVENT) THEN
        IF(IGENPAR(2).NE.0) PRINT 3022,(1.*ICALLS1)/ICALLS,
     &    (1.*ICALLS2)/ICALLS
        PRINT 3023,(1.*NEVENT)/CROSEC 
      END IF
c
      GOTO 500
c
c=======================================================================
c
 308  continue
c
c  e+e- -> J/psi(psi') -> VP (vector + pseudoscalar meson)
c
c   Parameters genpar(1-7): 

c      genpar(1): 1 for R=J/psi, 2 for R=psi'-meson
c      genpar(2): 1-11 decay mode of R
c      genpar(3): decay mode of vector meson
c      genpar(4): decay mode of psevdoscalar meson
c
      KC=134                              ! KC-Lund of J/psi
      IF(IGENPAR(1).EQ.2) KC=231          ! ...         psi'
      Ecm=pmas(kc,1)                      ! mass of J/psi (psi')
      EACT=Ecm/2                          ! actual beam energy in cms
c
      CALL PstPsiVP(igenpar(1),igenpar(2),igenpar(3),igenpar(4))
c
      goto 333
c
c=======================================================================
c
 309  continue
c
c  e+e- -> e+e- + X (X=pi0, eta, eta', eta_c or any GEANT particle, X=PS)
c
      EACT=GENPAR(1)
      GENPAR8(1)=GENPAR(1)
      KODtag=IGENPAR(2)
      MDEC=IGENPAR(3)
      KVDM=IGENPAR(4)
      GENPAR8(5)=GENPAR(5)
      GENPAR8(6)=GENPAR(6)
      GENPAR8(7)=GENPAR(7)
      GENPAR8(8)=GENPAR(8)
c
      IF(KGEN.EQ.303) IR=1
      IF(KGEN.EQ.304) IR=2
      IF(KGEN.EQ.305) IR=3
      IF(KGEN.EQ.322) IR=4
      APMASS=0.D0
c
      IF(KGEN.EQ.309) THEN ! arbitrary PS resonance
        IR=0
        MDEC=0
        ITYP=IGENPAR(3)       ! Geant typ of particle produced in gg
        ITHEP=INDP(ITYP)
c
        CALL PstPPar(ITHEP,ANAME,APMASS,WIDTH,CHRG,SPIN,CTAU) ! X parameters
c
      END IF

 3091 CALL PstGgRPS(GENPAR8(1),IR,MDEC,APMASS,1.D0,KVDM,GENPAR8(5),
     +               GENPAR8(6),GENPAR8(7),GENPAR8(8))
c
      ICALLS=0
      ICALLS1=0
      ICALLS2=0
c
      IF(KODTAG.GT.0) THEN
c
        CALL TS_TAG(304,GENPAR(1),KODTAG1,ICALLS,ICALLS1,ICALLS2)
c
        IF(KODTAG1.LT.KODTAG) GOTO 3091
      END IF
c
      IF(IEVENT.NE.NEVENT) GOTO 333
c
c  Print at end of simulation 
c
      ALT=NEVENT/TSEC
      PRINT 402,TSEC,ERSEC,ALT 
c
c-----------------------------------------------------------------------
c
 333  NTRACK=0
c
      DO 3032 I=1,NPS
   	IF(IChilds(1,I).ne.0) goto 3032  ! here - daughter of int. resonance
c
        if(kgen.eq.309.and.i.eq.3) KfTyp(i)=ithep
 	KHE=KfTyp(i)              ! HEP-code of particle
c
 	call PstPCode1(KHE,KGE)   ! HEP-code -> GEANT-code
c
 	plab(1)=pPart(1,i)
 	plab(2)=pPart(2,i)
 	plab(3)=pPart(3,i)
        ITYPE=KGE
c
 	NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=itype
 	epart(NTRACK)=pPart(4,I)
 	pxpart(NTRACK)=plab(1)  
 	pypart(NTRACK)=plab(2)  
	pzpart(NTRACK)=plab(3)  
c
 3032 continue 
c
      GOTO 500
c
c=======================================================================
c
 310  CONTINUE
c
c  This generator reads a event from file
c
c                         file   were read events  particles  in  
c                          |           |              |        |  
      CALL GEN_REVENT(IGENPAR(1), IGENPAR(2), NEVREAD, NPART, ARREVT)
c
c  IGENPAR(1)= 1-10 - file
c  IGENPAR(2)       - maximum number of events in file
c  NEVREAD          - were read events from file
c  NPART            - particles (tracks) in the event
c  ARREVT           - array with the event
c
      EACT=0.                           ! beam energy (special)
      VERG(1)=ARREVT(5,1)   ! vertex of event equals
      VERG(2)=ARREVT(6,1)   ! vertex of 1-st track of the event 
      VERG(3)=ARREVT(7,1)   ! 
c
       NTRACK=0
c
 	DO 3101 I=1,NPART
          RE_INT=ARREVT(1,I)
          ITYPE=INT_RE          ! particle type
          PLAB(1)=ARREVT(2,I)   ! Px
 	  PLAB(2)=ARREVT(3,I)   ! Py
          PLAB(3)=ARREVT(4,I)   ! Pz
c
          NTRACK=NTRACK+1
          IPARTICLE(NTRACK)=ITYPE
c
          CALL GFPART(ITYPE,CHNPAR,ITRTYP,PMASS,CHARGE,TLIFE,UB,NWB)
c
          EPART(NTRACK)=SQRT(PLAB(1)**2+PLAB(2)**2+PLAB(3)**2+PMASS**2)
          PXPART(NTRACK)=PLAB(1) 
          PYPART(NTRACK)=PLAB(2) 
          PZPART(NTRACK)=PLAB(3) 
 3101 CONTINUE 
c
      GOTO 500
c
c=======================================================================
c
 311  CONTINUE
c
c  Generator e+e- -> psi' -> psi(->l+l-) +pi+pi-
c
      KC=231                              ! KC-Lund of psi'
      Ecm=pmas(kc,1)                      ! mass of psi'
      EACT=Ecm/2                          ! actual beam energy in cms
c
      if (IGENPAR(1).eq.0) then
c.......
c   only pi+pi- - no J/psi product for trigger estimation
        CALL PstPsi1(1)
      else
c                   decay mode of J/psi
c                      |	
        CALL PstPsi1(IGENPAR(1))
      endif
c
c  IGENPAR(1)=0 : no J/psi - only pi+pi-
c            =1 : J/psi->e+e-
c            =2 : J/psi->mu+mu-
c
      NTRACK=0

      DO 3111 I=1,4
c
C       only pi+pi- - no J/psi product for trigger estimation
        if ((IGENPAR(1).eq.0).and.(I.eq.3)) GOTO 500

        KHE=KfTyp(I+1)              ! HEP-code of particle
c
        CALL PstPCode1(KHE,KGE)     ! HEP-code -> GEANT-code
c
        PLAB(1)=pPart(1,I+1)
        PLAB(2)=pPart(2,I+1)
        PLAB(3)=pPart(3,I+1)
        ITYPE=KGE
c
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE
        EPART(NTRACK)=pPart(4,I+1) 
        PXPART(NTRACK)=PLAB(1) 
        PYPART(NTRACK)=PLAB(2) 
        PZPART(NTRACK)=PLAB(3) 
c
 3111 CONTINUE
c
      GOTO 500
c
c=======================================================================
c
 312  CONTINUE
c
c  KGEN=312 - prints inform. about movement of particles of event 
c
      IF(IFIX(GENPAR(1)).LT.1.OR.IFIX(GENPAR(1)).GT.2) THEN
        PRINT *,' '
        PRINT *,' Wrong regime KPRINT in generator 312'
      	PRINT *,' '
        STOP
      END IF
c
      EACT=0.                ! beam energy (special)
      ITYPE = GENPAR(2)+0.5  ! particle type: is it in /PSPIND/ ?
      IF(IFIX(GENPAR(1)).EQ.1) THEN  ! 1-st regime: geantino
        ITYPE=48
        GENPAR(2)=48.
      END IF
c
      IF(IEVENT.EQ.1) PRINT 3121,(GENPAR(J),J=1,16)
      IF(ITYPE.LT.0.OR.(ITYPE.GT.33.AND.ITYPE.LT.44).OR.ITYPE.GT.NGNT)
     +   THEN
        PRINT *,' '
        PRINT *,' Error in generator # 312: wrong particle type = '
     $     ,ITYPE
        PRINT *,' '   
        STOP
      ENDIF
c
      VERTEX(1)=GENPAR(4)
      VERTEX(2)=GENPAR(5)
      VERTEX(3)=GENPAR(6)
c
      IF(IFIX(GENPAR(1)).EQ.2) ITYPE=IFIX(GENPAR(2))  ! particle type
      PP=GENPAR(3)           ! particle momentum GeV/c
c
      PLAB(1)=PP*SIN(GENPAR(7)*DEGRAD)*COS(GENPAR(8)*DEGRAD)
      PLAB(2)=PP*SIN(GENPAR(7)*DEGRAD)*SIN(GENPAR(8)*DEGRAD)
      PLAB(3)=PP*COS(GENPAR(7)*DEGRAD)
c
      NTRACK=0
      NTRACK=NTRACK+1
      IPARTICLE(NTRACK)=ITYPE
c
      CALL GFPART(ITYPE,NAMPART,ITRTYPE,PAMASS,PCHARGE,PTLIFE,UB,NWB)      
c
      EPART(NTRACK)=SQRT(PP**2+PAMASS**2)
      PXPART(NTRACK)=PLAB(1)
      PYPART(NTRACK)=PLAB(2)
      PZPART(NTRACK)=PLAB(3)
c
c  Test prints are being performed from gustep.f
c
      GOTO 500
c
c=======================================================================
c
c   Generator ee->tau tau (gamma) (KORAL-B)
c
 313  CONTINUE
c
c
c  Input parameters:                                                
c                                                                   
c GENPAR(1)    ENE -  energy of beam (GeV)                
c IGENPAR(2,3)       JAK1,JAK2  - number of tau decay mode      
c               = 1 - electron mode           
c               = 2 - muon mode               
c               = 3 - pion mode               
c	        = 4 - rho mode                
c	        = 5 - a1 mode                                         
c	        = 6 - K mode                                          
c	        = 7 - K* mode                                           
c	        = 8 - nPi mode                                          
c	        = 0 - inclusive (decays into all), JAK=1,2,3,4,5,6,7,8  
c IGENPAR(4)   ISPIN - (1)  switch for spin effects in tau decay              
c IGENPAR(5)   ITFIN - (1)  switch, if >1 - generation of other pairs than tau
c IGENPAR(6)   KEYGSW - (1) interference between gamma and Z exchange is incl.
c IGENPAR(7)   IFZET -  (0) switch for full implementation of Z               
c IGENPAR(8)   KEYRAD - (1) switch for QED bremmstrahlung                     
c IGENPAR(9)   ITDKRC - (1) switch for bremmstrahlung in tau decay            
c IGENPAR(10)  ITRANS - (1) switch for transverse spin correlations   
c GENPAR(11)   XK0 - (0.005) soft/hard photon cut-off for QED bremsstr.
c
      EACT=GENPAR(1)         ! actual beam energy
c
      CALL GEN_KORALB(GENPAR(1),IGENPAR(2),IGENPAR(3),IGENPAR(4),
     +          IGENPAR(5),IGENPAR(6),IGENPAR(7),IGENPAR(8),IGENPAR(9),
     +          IGENPAR(10),GENPAR(11),NSTABL,KPART,EVENT)
c
      NTRACK=0
c
      DO 3131 I=1,NSTABL
        ITYPE=KPART(I)          ! particle type
        PLAB(1)=EVENT(1,I)	! Px
        PLAB(2)=EVENT(2,I)	! Py
 	PLAB(3)=EVENT(3,I)	! Pz
c
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE
c
        CALL GFPART(ITYPE,CHNPAR,ITRTYP,PMASS,CHARGE,TLIFE,UB,NWB)
c
        EPART(NTRACK)=SQRT(PLAB(1)**2+PLAB(2)**2+PLAB(3)**2+PMASS**2)
        PXPART(NTRACK)=PLAB(1) 
        PYPART(NTRACK)=PLAB(2) 
        PZPART(NTRACK)=PLAB(3) 
c
 3131 CONTINUE 
c
      GOTO 500
c
c=======================================================================
c
c   Generator ee->2 particles ( ds/dz = A+Bz+Cz^2, z=cos(teta) )
c   i.e. PS PS: distribution ds/dz ~ 1-z^2              
c
 314  CONTINUE
c
c
c  Input parameters:                                                  
c                                                                
c  GENPAR(1)   <W> -  average energy of collision (GeV)                
c  GENPAR(2)   SIG_W - sigma of total energy of collision (Gev)
c  IGENPAR(3)  GEANT type of 1-st particle
c  IGENPAR(4)  GEANT type of 2-nd particle
c  GENPAR(5)   A
c  GENPAR(6)   B
c  GENPAR(7)   C
c
      GENPAR8(1)=GENPAR(1)
      GENPAR8(2)=GENPAR(2)
      GENPAR8(5)=GENPAR(5)
      GENPAR8(6)=GENPAR(6)
      GENPAR8(7)=GENPAR(7)
c
      CALL PstAbc(GENPAR8(1),GENPAR8(2),IGENPAR(3),IGENPAR(4),
     &            GENPAR8(5),GENPAR8(6),GENPAR8(7))  
c
      NTRACK=0
c
      DO 3141 I=1,NPS
 	IF(IChilds(1,I).NE.0) goto 3141  ! should be last daughter of int.res.
        ITYPE=0
        KODHEP=KfTyp(I)
c
 	CALL PstPCode1(KODHEP,ITYPE)  ! KF code -> GEANT code
c
 	IF(ITYPE.EQ.0) THEN
 	  print *,' GUKINE_T: for gen.314 unknown type of particle',
     +            KfTyp(I)
 	 	  STOP
        END IF
c
 	PLAB(1)=pPart(1,I)
 	PLAB(2)=pPart(2,I)
 	PLAB(3)=pPart(3,I)
c	                
 	NTRACK=NTRACK+1
 	IPARTICLE(NTRACK)=ITYPE
 	EPART(NTRACK)=pPart(4,I) 
 	PXPART(NTRACK)=PLAB(1) 
 	PYPART(NTRACK)=PLAB(2) 
        PZPART(NTRACK)=PLAB(3) 
c
 3141   CONTINUE
c
        EACT=0.             ! actual beam energy in cms (special)

c
      GOTO 500
c
c=======================================================================
c
 315  CONTINUE
c
c  Generator e+e- -> psi' -> ...
c
c  IGENPAR(1): number of decay mode:
c
c  0 - all
c  1 - e+ e-
c  2 - mu+ mu-
c  3 - rndmflav
c  4 - J/psi pi+ pi-
c  5 - J/psi pi0 pi0
c  6 - J/psi eta0
c  7 - J/psi pi0 
c  8 - chi_c0 gamma
c  9 - chi_c1 gamma
c  10 -chi_c2 gamma
c  11 -eta_c gamma
c
c  IGENPAR(2)=1,2 - include final state r.c.
c
      KC_PSI1=LUCOMP(30443)	      ! kc - short code of paticle psi'
      ECM=PMAS(KC_PSI1,1)
      EACT=ECM/2                      ! actual beam energy in cms
c
      IF(IGENPAR(1).LT.0.OR.IGENPAR(1).GT.11) THEN ! error
        PRINT 3152,IGENPAR(1)
        STOP
      END IF
c
      IF(IEVENT.EQ.1) THEN
        PRINT 3151,IGENPAR(1),T315(IGENPAR(1)+1),IGENPAR(2),ECM  ! print title
c
        IF(IGENPAR(2).GT.0) CALL PHOINI  ! initialization of PHOTOS
c
      END IF       
c
      CALL LU1ENT(-1,30443,ECM,0.,0.) ! new particle: psi', teta=0, fi=0
c
      NB_CHAN=MDCY(KC_PSI1,3)         ! number of channals for psi' decay
      I1_CHAN=MDCY(KC_PSI1,2)         ! position of 1-st channal
c
      IMODE=IGENPAR(1)
c
      IF(IMODE.GT.0) THEN
c
        DO I=1,NB_CHAN                ! select necessary decay mode 
          IDC=I1_CHAN+I-1
  	  IF(I.NE.IMODE) MDME(IDC,1)=0
        END DO
c
      END IF
c
      CALL LUEXEC	  ! calls chain of fragmentations and decays
c
c      CALL LUEDIT(2)	  ! excludes unstable or undetectable particles
c
c======
      IF(IGENPAR(2).GT.0) THEN  ! f.s. rad. corr. by PHOTOS
c
        CALL LUHEPC(1)        ! Conversion from JETSET to /HEPEVT/ standard
c
        NEVHEP=IEVENT
c
c        CALL PHODMP           ! Write event record before emission...
c
        CALL PHOTOS(1)        ! Generate photon(s)...
c
c        PRINT 9050            ! Write event record...
c        PRINT 9040
c
c        CALL PHODMP           ! Write event record after emission...
c
c        PRINT 9000
c        PRINT 9010
c        PRINT 9020
c        PRINT 9030
c        PRINT 9020
c        PRINT 9010
 9000 FORMAT(1H1)  
 9010 FORMAT(1H ,80('*'))
 9020 FORMAT(1H ,'*',78X,'*')
 9030 FORMAT(1H ,'**** PHOTOS Test Run has successfully ended',32X,
     &' ****')
 9040 FORMAT(1H ,26X,'=== after PHOTOS: ===')
 9050 FORMAT(1H0,80('='))
c
        CALL LUHEPC(2)        ! Conversion from /HEPEVT/ to JETSET standard
c
      END IF
c
      NTRACK=0
c
      DO I=1,N          
        ITYPE=0
        KS=KK(i,1)
        KODHEP=KK(I,2)
c
        IF(KS.EQ.1.OR.KS.EQ.4) THEN
c
          CALL PstPCode1(KODHEP,ITYPE)  ! KF code -> GEANT code
c
 	  IF(ITYPE.EQ.0) THEN
            write(6,*)' Gen.315: unknown type of particle', kk(i,2)
            STOP
          END IF
c
          PLAB(1)=P(I,1)
          PLAB(2)=P(I,2)
          PLAB(3)=P(I,3)      
c
          NTRACK=NTRACK+1
 	  IPARTICLE(NTRACK)=ITYPE
 	  EPART(NTRACK)=EN1
 	  PXPART(NTRACK)=PLAB(1)
 	  PYPART(NTRACK)=PLAB(2)
 	  PZPART(NTRACK)=PLAB(3)
c	
        END IF
c
      END DO
c
      GOTO 500
c
c=======================================================================
c
 316  CONTINUE   
c
c  Generator e+e- -> gamma + X (d.f. for gamma: 1+cos^2 teta)
c
c  Input parameters:
c                   

c  GENPAR(1)   <W> = <2 x Ebeam> -  average lab energy of collision (GeV)
c  GENPAR(2)   SIGMA_W - of total energy of collision (Gev)
c  IGENPAR(3)  GEANT type of particle X.
c              (for original GEANT (type 1-32,45-50) - without decays here,
c               for extended GEANT (type > 50) - decays are performed here)
c  Photon energy is determined inside generator
c
      GENPAR8(1)=GENPAR(1)
      GENPAR8(2)=GENPAR(2)
c
      CALL PstGammaX(GENPAR8(1),GENPAR8(2),IGENPAR(3))      
c
      NTRACK=0
c
      DO 3161 I=1,NPS 
        IF(IChilds(1,I).NE.0) goto 3161  ! should be last daughter of int.res.
        ITYPE=0
        KODHEP=KfTyp(I)
c
 	CALL PstPCode1(KODHEP,ITYPE)  ! KF code -> GEANT code
c
 	IF(ITYPE.EQ.0) THEN
 	  print *,' GUKINE_T: for gen.316 unknown type of particle', 
     +            KfTyp(I)
 	  STOP
 	END IF
c
 	PLAB(1)=pPart(1,I)
 	PLAB(2)=pPart(2,I)      
 	PLAB(3)=pPart(3,I)      
c 	                                    
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE
        EPART(NTRACK)=pPart(4,I)
        PXPART(NTRACK)=PLAB(1)
        PYPART(NTRACK)=PLAB(2)
        PZPART(NTRACK)=PLAB(3)
c
 3161   CONTINUE
c
      GOTO 500
c
c=======================================================================
c
 317  CONTINUE
c
c  Generator e+e- -> e+e- + e+e-(mu+ mu-) (J.A.M.Vermaseren)
c
c  Input parameters:
c
c  GENPAR(1)  - (EB) Energy of beam in GeV     
c  IGENPAR(2) - (IPROC) process: 
c             1 - e+e- -> e+e- + e+e- (main diagrmas) 
c             2 - e+e- -> e+e- + e+e- (Bremssthrahlung diagrmas only)
c             3 - e+e- -> e+e- + e+e- (main + Bremsstr. diagrmas)
c             4 - e+e- -> e+e- + e+e- (main + identical particle eff)
c             5 - e+e- -> e+e- + e+e- (main + Bremsstr. + identical eff)
c             6 - e+e- -> e+e- + mu+mu- (main diagrmas)
c             7 - e+e- -> e+e- + mu+mu- (main +Bremsstr. diagrmas)  
c  IGENPAR(3) - (NIT)  NIT >= 0 - iterations with calc. of grid for simulation  
c  IGENPAR(4) - (NPR)  < 0 - there are not any prints from integration
c                      = 0 - print initial data for int. and final results
c                      = 1   as =0 + prit for evry iteration
c                      = 2   as =1 + print grid
c  IGENPAR(5) - (NCAL) approximate number of integrand evaluations
c  GENPAR(6)  - (FMAJ) majoranta for this process and energy, if FMAJ<=0.
c                it is determined by generator
c  Output:
c 
c  VEPART(4,4) - P,E - parameters of generated particles
c  ITER,TI1,TS1 - iterations, int., accum. int.
c
      EACT=GENPAR(1)  ! actual beam energy in cms
c
      CALL GEN_VERMAS(GENPAR(1),IGENPAR(2),IGENPAR(3),IGENPAR(4),
     +     IGENPAR(5),GENPAR(6),VEPART,ITER,TI1,TS1,AVGI,SD,CHI2A)
c
      NTRACK=0
c
      DO 3171 I=1,4
        PLAB(1)=VEPART(I,1)                    
        PLAB(2)=VEPART(I,2)                    
        PLAB(3)=VEPART(I,3)
        IF(I.EQ.1) ITYPE=2
        IF(I.EQ.2) ITYPE=3
c
        IF(I.EQ.3) THEN
          ITYPE=2  ! e+
          IF(IGENPAR(2).GE.6) ITYPE=5  ! mu+
        END IF
c
        IF(I.EQ.4) THEN
          ITYPE=3  ! e-
          IF(IGENPAR(2).GE.6) ITYPE=6  ! mu-
        END IF                              
c                                           
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE
        EPART(NTRACK)=VEPART(I,4)
        PXPART(NTRACK)=PLAB(1)
        PYPART(NTRACK)=PLAB(2)
        PZPART(NTRACK)=PLAB(3)
c
 3171 CONTINUE
c
      IF(IEVENT.EQ.NEVENT) THEN
c
        IF(IGENPAR(4).EQ.0) PRINT 3173,ITER,TI1*1000,TS1*1000,AVGI*1000,
     +                      SD*1000,CHI2A      ! results of last iteration
c
        PRINT 3172,INPMAJ,FMAXI
      END IF
c
      GOTO 500
c
c=======================================================================
c
 318  CONTINUE
c
c  Generator e+e- -> e+e- + (tau+ tau-) (J.A.M.Vermaseren)                   
c
c  Input:
c
c  GENPAR(1)  - (EB) Energy of beam in GeV
c  IGENPAR(2) - (NIT)  NIT >= 0 - iterations with calc. of grid for simulation
c  IGENPAR(3) - (NPR)  < 0 - there are not any prints from integration
c                      = 0 - print initial data for int. and final results
c                      = 1   as =0 + prit for evry iteration
c                      = 2   as =1 + print grid
c  IGENPAR(4) - (NCAL) approximate number of integrand evaluations
c  GENPAR(5)  - (FMAJ) majoranta for this process and energy, if FMAJ<=0.
c                it is determined by generator
c  Output:
c 
c  VEPART(4,4) - P,E - parameters of generated particles
c  ITER,TI1,TS1 - iterations, int., accum. int.
c
      EACT=GENPAR(1)   ! actual beam energy in cms
c
      CALL GEN_VERMAS(GENPAR(1),8,IGENPAR(2),IGENPAR(3),  ! 8:2tau, main diag.
     +     IGENPAR(4),GENPAR(5),VEPART,ITER,TI1,TS1,AVGI,SD,CHI2A)
c
      NTRACK=0
c
      DO 3181 I=1,4
        PLAB(1)=VEPART(I,1)
        PLAB(2)=VEPART(I,2)
        PLAB(3)=VEPART(I,3)
        IF(I.EQ.1) ITYPE=2  ! e+
        IF(I.EQ.2) ITYPE=3  ! e-
        IF(I.EQ.3) ITYPE=51 ! tau+
        IF(I.EQ.4) ITYPE=52 ! tau-                              
c	                                    
 	NTRACK=NTRACK+1
 	IPARTICLE(NTRACK)=ITYPE
        EPART(NTRACK)=pPart(4,I)
 	PXPART(NTRACK)=PLAB(1)   
 	PYPART(NTRACK)=PLAB(2)   
 	PZPART(NTRACK)=PLAB(3) 
c  
 3181 CONTINUE
c
      IF(IEVENT.EQ.NEVENT) THEN
c
 	IF(IGENPAR(3).EQ.0) PRINT 3173,ITER,TI1*1000,TS1*1000,AVGI*1000,
     +                      SD*1000,CHI2A  ! results of last iteration
c
 	PRINT 3172,INPMAJ,FMAXI
      END IF
c
      GOTO 500
c
c=======================================================================
c
 319  CONTINUE
c
c  Generator e+e- -> e+e- + pi+pi- 
c
c  Input:
c
c  GENPAR(1)  - Energy of beam in GeV
c  IGENPAR(2) - regim of calc. of cross-section                            
c                 1 - Born, lambda=0                                  
c                 2 - Born, lambda=2                                  
c                 3 - Born(lambda=0) + Born(lambda=2)                           
c                 4 - Born(l=0)+interf.ampl. |Born(l=2) + f_2(1270)| 
c                 5 - f_2(1270)                                       
c  GENPAR(3)-GENPAR(4) - inv. masses (GeV) interval                            
c  IGENPAR(5) - key  Vector Dom. model: 1 - included                     
c  GENPAR(6), GENPAR(7)  - cut on -t1 (>0) for subr. INV 
c  GENPAR(8), GENPAR(9)  - cut on -t2 (>0) for subr. INV    
c                                                
      EACT=GENPAR(1)           ! actual beam energy in cms                     
      GENPAR8(1)=GENPAR(1)
      GENPAR8(3)=GENPAR(3)
      GENPAR8(4)=GENPAR(4)
      KVDM=IGENPAR(5)     
      GENPAR8(6)=GENPAR(6)
      GENPAR8(7)=GENPAR(7)
      GENPAR8(8)=GENPAR(8)
      GENPAR8(9)=GENPAR(9)
c
      CALL PstGg2pi(GENPAR8(1),IGENPAR(2),GENPAR8(3),GENPAR8(4),KVDM,
     &       GENPAR8(6),GENPAR8(7),GENPAR8(8),GENPAR8(9))
c
      NTRACK=0
c
      DO I=1,4
        PLAB(1)=pPart(1,I)
        PLAB(2)=pPart(2,I)
        PLAB(3)=pPart(3,I)
c             
        IF(I.EQ.1) ITYPE=3  ! e-
        IF(I.EQ.2) ITYPE=2  ! e+
        IF(I.EQ.3) ITYPE=9  ! pi-
        IF(I.EQ.4) ITYPE=8  ! pi+
c                                
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE
        EPART(NTRACK)=pPart(4,I)
        PXPART(NTRACK)=PLAB(1)   
        PYPART(NTRACK)=PLAB(2)   
        PZPART(NTRACK)=PLAB(3)
c   
      END DO
c
      IF(IEVENT.EQ.NEVENT) THEN          ! last event
        ALT=NEVENT/TSEC
        PRINT 402,TSEC,ERSEC,ALT
      END IF
c
      GOTO 500
c
c=======================================================================
c
 320  CONTINUE   !  KMD-generator (MCGPJ)
c
c  KMD-generator (used e+e- -> e+e-, mu+mu-, tau+tau- with r.c.)
c
c  Input:
c
c  GENPAR(1)  - Energy of beam in GeV
c  IGENPAR(2) - process: 
c               1 - Bhabha, 
c               2 - mu+mu-,
c               3 - tau+tau-
c  GENPAR(3)  - accuracy of cr.sec in nb
c  GENPAR(4)  - min. angle with axis, degrees
c  GENPAR(5)  = 0/1 - calculation outside/inside resonance   
c
      EACT=GENPAR(1)            ! actual beam energy in cms
      EBEAM=GENPAR(1)*1000      ! Beam energy, GeV ->MeV
      IPROC=IGENPAR(2)-1        ! now 0-2
      IF(IPROC.EQ.2) IPROC=5    
      ACC=GENPAR(3)             ! Accuracy of cr.sec, nb
      ANGMIN=GENPAR(4)*PI/180.  ! deg -> rad      
c
      IF(IGENPAR(2).LT.1.OR.IGENPAR(2).GT.3) THEN 
        PRINT 3201,IPROC+1       ! pi+pi-, KSKL, K+K- are excluded, since ff 
c                                 are not valid at our energy
        STOP 
      END IF 
c
      IF(IEVENT.EQ.1) THEN  ! first event - initialization of generator
c
        PRINT 324,IGENPAR(2),TEXT320(IGENPAR(2)),GENPAR(1),GENPAR(3),
     &            GENPAR(4),IGENPAR(5)

        CALL INIT_PRIME_GEN(IPROC,EBEAM,ACC,ANGMIN,IGENPAR(5)) 
      END IF
c
      CALL MAKEEVENT(QQ,ISORT,NPRT)  ! event of MCGPJ
c
      NTRACK=0
c
      DO 422 I=1,NPRT                     ! cycle on particles from MCGPJ
c
        IF(ISORT(I).EQ.1.AND.QQ(4,I).LE.0.) GOTO 422  ! P(photon) <= 0 
c
        PLAB(1)=QQ(4,I)*QQ(1,I)     ! Px in GeV
        PLAB(2)=QQ(4,I)*QQ(2,I)
        PLAB(3)=QQ(4,I)*QQ(3,I)
        ITYPE=ISORT(I) ! 51, 52: tau+-  should decay in kedr_dec.dat
c
        NTRACK=NTRACK+1
        IPARTICLE(NTRACK)=ITYPE           ! GEANT-code:1,2,...,51,52
        EPART(NTRACK)=SQRT(QQ(4,I)**2+AMASS(ITYPE)**2)  ! energy in GeV
        PXPART(NTRACK)=PLAB(1)        
        PYPART(NTRACK)=PLAB(2) 
        PZPART(NTRACK)=PLAB(3) 
c
 422    CONTINUE
c
      IF(IEVENT.EQ.NEVENT) THEN         ! last event
c
        CALL GENFINISH                  ! finish of work of KMD-generator

c        ALT=NEVENT/TSEC
c        PRINT 400,TSEC,ERSEC,ALT,FM,NGT
      END IF
c
      GOTO 500
c
c=======================================================================
c
 321  CONTINUE   !  Bremmstrahlung-generator 
c
c  Generator  e+e- -> e+e- gamma (in one dir.) in lowest order with
c  account of effect of impact parameters limitation
c
c  Input:
c
c  GENPAR(1)  - energy of beam in GeV (0.1 - 7.5 GeV)
c  GENPAR(2)  - photon min. energy (>0.0015 GeV)
c  GENPAR(3)  - horizontal beam size, cm
c  GENPAR(4)  - vertical beamsize, cm
c  GENPAR(5)  - horiz. angular size, Rad
c  GENPAR(6)  - vertical angular size, Rad
c  IGENPAR(7) - phot. direction (0 -both, 1 - in e- dir., 2 - in e+ dir.)         
c  IGENPAR(8) - 1 - include impact parameters limitation
c  IGENPAR(9) - 1 - include beam angular spread 
c  GENPAR(10) - sigma of Gaussian beam energy spred in GeV
c
      EACT=0.              ! actual beam energy (special)
      EBEAM=GENPAR(1)      ! beam energy
      WIDTH=GENPAR(10)     ! its sigma      
      OMEMIN=GENPAR(2)
      HSIGB=GENPAR(3)
      VSIGB=GENPAR(4)
      THSIGB=GENPAR(5)
      TVSIGB=GENPAR(6)
c
      CALL PstBrem(EBEAM,WIDTH,OMEMIN,HSIGB,VSIGB,THSIGB,TVSIGB,
     &             IGENPAR(7),IGENPAR(8),IGENPAR(9),ELEFIN,PHOFIN,
     &             SECBREM,ERRBREM) 
c
      NTRACK=0
c
c  Secondary e- (e+)
c
      DO I=1,3
        PLAB(I)=ELEFIN(I)
      END DO
c
      IF(IGENPAR(7).EQ.1) THEN
        ITYPE=3
        GOTO 3211      
      END IF
c
      IF(IGENPAR(7).EQ.2) THEN
        ITYPE=2
        GOTO 3211
      END IF
c
      ITYPE=3
      IF(ELEFIN(3).LT.0.) ITYPE=2   ! both directions
c
 3211 CONTINUE
c
      NTRACK=NTRACK+1
      IPARTICLE(NTRACK)=ITYPE
      EPART(NTRACK)=ELEFIN(4)
      PXPART(NTRACK)=ELEFIN(1)
      PYPART(NTRACK)=ELEFIN(2)
      PZPART(NTRACK)=ELEFIN(3)
c
c  Bremsstrahlung photon
c
      DO I=1,3
        PLAB(I)=PHOFIN(I)
      END DO
c
      ITYPE=1
c
      NTRACK=NTRACK+1
      IPARTICLE(NTRACK)=ITYPE
      EPART(NTRACK)=PHOFIN(4)
      PXPART(NTRACK)=PHOFIN(1)
      PYPART(NTRACK)=PHOFIN(2)
      PZPART(NTRACK)=PHOFIN(3)
c
      IF(IEVENT.EQ.NEVENT) THEN           ! last event
        ERRBREM=ERRBREM/SECBREM*100
        PRINT 3212,SECBREM,ERRBREM,(1.*NEVENT)/SECBREM
      END IF
c
      GOTO 500
c
c=======================================================================
c
 323  CONTINUE   !  BabaYaga 3.5 generator
c
c  Generator  e+e- -> e+e-, mu+mu-, gam gam, pi+pi- Ó ÒÁÄÐÏÐÒÁ×ËÁÍÉ
c
c  Input:
c
c  GENPAR(1)  - energy of beam in GeV (0.5 - 5 GeV)
c  IGENPAR(2) - channel: 1 - e+e- (n gam),   2 - mu+mu- (n gam),
c                        3 - mu+mu- (n gam), 4 - pi+pi- (n gam)
c  GENPAR(3)  - min. energy of particle of pair, GeV
c  GENPAR(4)  - minimum angle with beam axis, deg.
c  GENPAR(5)  - maximum angle of acollinearity, deg.
c  IGENPAR(6)  =1/0 - 1: include hadr. resonances in vacuum polarization
c  GENPAR(7) - maximum weight, if <=0 - determined in the generator                
c
      EBEAM=GENPAR(1)
      EMIN=GENPAR(3)
      ZMAX=GENPAR(5)      
      THMIN=GENPAR(4)   ! minimum angle with beam axis, deg.
      IRES=IGENPAR(6)   ! inclusion of resonances in VP
      THMAX=180.-THMIN  ! maximum angle with beam axis, deg.
      FMAX=GENPAR(7)
c
      CALL GEN_BBYGA35(IGENPAR(2),EBEAM,THMIN,THMAX,EMIN,ZMAX,IRES,FMAX)
c
      IF(IGENPAR(2).EQ.1) IPARTICLE(1)=2 ! final state: e+e-
      IF(IGENPAR(2).EQ.2) IPARTICLE(1)=5 ! mu+ mu-
      IF(IGENPAR(2).EQ.3) IPARTICLE(1)=1 ! gam gam
      IF(IGENPAR(2).EQ.4) IPARTICLE(1)=8 ! pi+ pi-    
      PXPART(1)=BBYEVENT(17)
      PYPART(1)=BBYEVENT(18)
      PZPART(1)=BBYEVENT(19)
      EPART(1)=BBYEVENT(20)
      IF(IGENPAR(2).EQ.1) IPARTICLE(2)=3 ! final state: e+e-
      IF(IGENPAR(2).EQ.2) IPARTICLE(2)=6 ! mu+ mu-
      IF(IGENPAR(2).EQ.3) IPARTICLE(2)=1 ! gam gam
      IF(IGENPAR(2).EQ.4) IPARTICLE(2)=9 ! pi+ pi-
      PXPART(2)=BBYEVENT(21)
      PYPART(2)=BBYEVENT(22)
      PZPART(2)=BBYEVENT(23)
      EPART(2)=BBYEVENT(24)
c
      IMAX=BBYEVENT(25)+0.1     ! number of gammas
      NTRACK=2
      IF(IMAX.EQ.0) GOTO 3232
c
      DO I=1,IMAX
        NTRACK=NTRACK+1
        I1=4*(NTRACK-3)
        IPARTICLE(NTRACK)=1
        PXPART(NTRACK)=BBYEVENT(I1+1)
        PYPART(NTRACK)=BBYEVENT(I1+2)
        PZPART(NTRACK)=BBYEVENT(I1+3)
        EPART(NTRACK) =BBYEVENT(I1+4)
      END DO
c
 3232 IF(IEVENT.EQ.NEVENT) THEN           ! last event
        Print *,' '
        PRINT 3230
        Print *,'  --------------- Results of simulation ------------'
        Print *,' '

        IF(CTRL.gt.0) THEN
          Print *,' Warning: Maximum weight too small:'
          Print *,' Maximum weight was exceeded ',CTRL,' times'
          PRINT *,' Per NCALLS=',XNCALLS,' (',CTRL/XNCALLS*100,')%'
        END IF

        PRINT 3235, SDMAX,SDMAXR
        IF(CTRL.EQ.0) print *,' NCALLS=',XNCALLS
        PRINT *,' Efficiency=',(100.*NEVENT)/XNCALLS,' %'
        PRINT 3234,SEZ,ERR,WSEZ,WERR ! unweighted and weighted cr. sections                                       
        PRINT 3230
      END IF
c        
cXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
c
 500  CONTINUE
c
 324  FORMAT(/,1x,60(1H*),//,
     &   ' Generator 320, process=',I2,': e+e- -> ',A15,/,
     &   ' Ebeam=',F8.4,' GeV',/,
     &   ' Acc of cr. sec.=',F8.4,' nb',/,
     &   ' Min. angle with axis=',F8.4,' Deg.',/,
     &   ' Hadron v.p. corr. inclusion =',I2,': 0-all/1-without res.'
     &    ,//,1x,60(1H*),/)
 398  FORMAT(//,' Event',/)
 395  FORMAT(1x,i3,' P=',3f10.3,' typ=',i2)
 400  FORMAT(/,80(1h*),//,' Cross section =',1pe9.2,' +-',1pe9.2,' nb',/
     &       ,' L*t= ',1pe9.2,' 1/nb',/,
     &       ' Fmax =',1pe9.2,/, ' NGT =',I3,//,80(1h*))
 401  FORMAT(/,80(1h*),//,
     +       ' Fmax =',1pe9.2,/, ' NGT =',I3,//,80(1h*))
 402  FORMAT(/,80(1h*),//,' Cross section =',1pe9.2,' +-',1pe9.2,' nb',/
     &       ,' L*t= ',1pe9.2,' 1/nb',//,80(1h*))
 3022 FORMAT(/,' Fractions of st- and dt-events: ',2F6.3,/)  
 3023 FORMAT(/,' L*t=',1pE12.3,' 1/nb',/)
 3121 FORMAT(/,1x,60(1H*),//,
     +       ' One particle simulation with test print',//,
     +        F5.1  ,' -  regime: 1- geantino / 2- any particle',/,
     +        F6.1,'	- particle type',/,
     +        1pE10.2,' - particle momentum (GeV/c)',/,
     +        1pE10.2,' - Xo (cm.)',/,
     +        1pE10.2,' - Yo (cm.)',/,
     +        1pE10.2,' - Zo (cm.)',/,
     +        1pE10.2,' - theta (deg.)',/,
     +        1pE10.2,' - phi (deg.)',/,
     +        0p6F5.1  ,' - GEANT types of unseen particles',
     +		 //,1x,60(1H*),/)
 3151 FORMAT(/,1x,60(1H*),//,
     &   ' Generator 315, process=',I2,': e+e- -> psi ->',A14,/,
     &   ' Final state radiation =',I2,/,
     &   ' M(psi-prime)=',F8.4,' GeV'
     &    ,//,1x,60(1H*),/) 
 3152 FORMAT(/,' Error in data for Generator 315, mode=',I2,' ?',/)
 3172 FORMAT(/,I10, ' - number of weights more than majoranta',/,
     +       1pe10.2,' - maximum weight',/)
 3173 FORMAT( /,' Iter. No',I3,': Int=',1PD10.3,' +-',
     1 1PD10.3,' nb',/,
     2 ' Accum. res.: Int=',1PD10.3,' +-',
     3 1PD10.3,' nb  chi**2 per int=',0pF10.3,/)
 3201 FORMAT(/,' Error in data for Generator 320, process=',I2)
 3212 FORMAT(/,' Sigma =',1pE10.3,' cm^2 (+-',0pF6.3,'%) : ',
     &         'cross-section for generated events',//,
     &         ' L*t = ',1pE10.2,' 1/cm^2',/)
 3230 FORMAT(/,1x,60(1H*),/)
c
 3231 FORMAT(' Ebeam =',F7.4,' GeV',/,
     &   ' Minimum angle with axis =',F8.2,' deg.',/,
     &   ' Maximum acollinearity =',F9.2,' deg.',/,
     &   ' Resonances inclusion in VP =',I2)
 3233 FORMAT(' PS photons cuts: E >',F7.4,' GeV, theta-min =',F6.2,
     &' deg.')
 3234 FORMAT(/,'  Unweighted cross section =',1pE12.3,' +-',
     &          1pE10.3,' nb',/,
     &         '  Weighted cross section   =',1pE12.3,' +-',
     &          1pE10.3,' nb')
 3235 FORMAT('  Used and real maximum weight:',2(1pE12.3))

      END
